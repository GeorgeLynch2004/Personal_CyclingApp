<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="https://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">

    <title>Sign Up</title>
    <link rel="stylesheet" th:href="@{/scripts/css/global.css}">
    <link rel="stylesheet" th:href="@{/scripts/css/navbar.css}">
    <link rel="stylesheet" th:href="@{/scripts/css/form.css}">

</head>
<body>
<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="form-page">
    <div class="form-card">
        <h1>Sign Up</h1>

        <form id="signUpForm" th:action="@{/users/signup}" method="post">
            <div class="form-field">
                <label for="username">Username</label>
                <input id="username" type="text" name="username" placeholder="username" required/>
            </div>
            <div class="form-field">
                <label for="email">Email</label>
                <input id="email" type="text" name="email" placeholder="email" required/>
            </div>
            <div class="form-field">
                <label for="password">Password</label>
                <input id="password" type="password" name="password" placeholder="password" required/>
            </div>
            <div class="form-field">
                <label for="password2">Re-type Password</label>
                <input id="password2" type="password" name="password2" placeholder="re-type password" required/>
            </div>
            <div id="formFeedback">

            </div>
            <button class="form-button" type="submit">Sign Up</button>
            <a th:href="@{/pages/login}">Already have an account? Sign in here.</a>
        </form>
    </div>
</div>
</body>
</html>
<script>
    const form = document.getElementById("signUpForm");

    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        await validation(form);
    });

    async function validation(form){
        const username = form.username.value.trim();
        const email = form.email.value.trim();
        const password = form.password.value;
        const password2 = form.password2.value;
        const feedbackDiv = document.getElementById("formFeedback");

        feedbackDiv.textContent = ""; // clear previous message

        const usernameValid = await usernameValidation(feedbackDiv, username);
        const emailValid = await emailValidation(feedbackDiv, email);
        const passwordValid = passwordValidation(feedbackDiv, password);
        const match = passwordsMatch(feedbackDiv, password, password2);

        if (usernameValid && emailValid && passwordValid && match){
            const formData = new FormData();
            formData.append("username", username);
            formData.append("email", email);
            formData.append("password", password);

            const res = await fetch("/users/signup", {
                method: "POST",
                headers: {
                    [document.querySelector('meta[name="_csrf_header"]').content]:
                    document.querySelector('meta[name="_csrf"]').content
                },
                body: formData
            });

            if (res.ok){
                window.location.href="/pages/login";
            } else{
                const error = await res.text();
                console.error(error);
                feedbackDiv.textContent = error;
            }
        }
    }

    function passwordsMatch(feedbackDiv, password1, password2){
        if (password1 === password2){
            return true;
        }
        feedbackDiv.textContent += "Passwords don't match.\n";
        return false;
    }

    function passwordValidation(feedbackDiv, password){
        if (password.length < 8 || password.length > 20) {
            feedbackDiv.textContent += "Password must be 8–20 characters.\n";
            return false;
        }

        const hasUppercase = /[A-Z]/.test(password);
        const hasNumber = /[0-9]/.test(password);
        const hasSymbol = /[^A-Za-z0-9]/.test(password);

        if (!hasUppercase || !hasNumber || !hasSymbol) {
            feedbackDiv.textContent += "Password must contain uppercase, number, and symbol.\n";
            return false;
        }

        return true;
    }

    function usernameValidation(feedbackDiv, username) {
        // Clear previous feedback
        feedbackDiv.textContent = "";

        if (!username || username.trim() === '') {
            feedbackDiv.textContent += "Username is required.\n";
            return false;
        }

        username = username.trim();

        if (username.length < 8 || username.length > 40) {
            feedbackDiv.textContent += "Username must be 8–40 characters.\n";
            return false;
        }

        // Only allow letters, numbers, underscores, and hyphens
        const validUsernameRegex = /^[a-zA-Z0-9_-]+$/;
        if (!validUsernameRegex.test(username)) {
            feedbackDiv.textContent += "Username can only contain letters, numbers, underscores, and hyphens.\n";
            return false;
        }

        // Must contain at least one letter
        if (!/[a-zA-Z]/.test(username)) {
            feedbackDiv.textContent += "Username must contain at least one letter.\n";
            return false;
        }

        // Cannot start or end with special characters
        if (/^[_-]|[_-]$/.test(username)) {
            feedbackDiv.textContent += "Username cannot start or end with underscores or hyphens.\n";
            return false;
        }

        // Cannot have consecutive special characters
        if (/[_-]{2,}/.test(username)) {
            feedbackDiv.textContent += "Username cannot contain consecutive special characters.\n";
            return false;
        }

        // Check for reserved words
        const reservedWords = ['admin', 'root', 'system', 'null', 'undefined', 'administrator'];
        if (reservedWords.includes(username.toLowerCase())) {
            feedbackDiv.textContent += "This username is reserved and cannot be used.\n";
            return false;
        }

        return true;
    }

    function emailValidation(feedbackDiv, email) {
        // Clear previous feedback
        feedbackDiv.textContent = "";

        if (!email || email.trim() === '') {
            feedbackDiv.textContent += "Email is required.\n";
            return false;
        }

        email = email.trim();

        if (email.length > 254) {
            feedbackDiv.textContent += "Email is too long.\n";
            return false;
        }

        // RFC 5322 compliant email regex
        const emailRegex = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;

        if (!emailRegex.test(email)) {
            feedbackDiv.textContent += "Please enter a valid email address.\n";
            return false;
        }

        // Check for consecutive dots
        if (email.includes('..')) {
            feedbackDiv.textContent += "Email cannot contain consecutive dots.\n";
            return false;
        }

        // Check that local part (before @) doesn't start or end with a dot
        const [localPart, domain] = email.split('@');
        if (localPart.startsWith('.') || localPart.endsWith('.')) {
            feedbackDiv.textContent += "Email format is invalid.\n";
            return false;
        }

        // Basic domain validation
        if (!domain || !domain.includes('.')) {
            feedbackDiv.textContent += "Email must have a valid domain.\n";
            return false;
        }

        return true;
    }
</script>
